.filter
  h2 Filter by #{key}

- if(!query[key]) query[key] = []
- delete query.xhr

.zoomable
  ul.choices.clearfix
    each choice in choices.slice(0, 30)
      li.choice.bubble.hidden(
        id='choice-' + choice.code, 
        data-name=choice.name, data-value=choice.value, data-colour=''
      )
        .outline
        .inner
          - q = _.extend({}, query)
          - q[key] = _.uniq(_.flatten([q[key], choice.code]))
          a.content.xhr(href=url('/activities', q))
            p.text.hidden= choice.name + " \n $123b \n " + choice.count + " projects"

script
  inlines.push(function() {
    var wrapper = $(".zoomable");
    var container = wrapper.children(".choices");
    var activities = container.children(".choice");
    var content = activities.find(".content");
    
    Math.seedrandom($('.choices').map(function() { return $(this).attr("id"); }).toArray().join(""));
    $('.choices').bubbleLayout({
      bubbleClasses: bubbleClasses, layout: 'list', font: {min: 9, max: 25}, diameter: {min: 130, max: 250},
      afterFit: function() {
        var notEmpty = function() { return $(this).text() !== ""; }
        var textLines = $(this).children().filter(notEmpty).toArray();
        $(textLines.slice(-2)).addClass("small");
      }
    });
    
    
    var currentScale = 1;
    var zoom = $(".zoomable");
    z = new Zoomer(zoom.get(0), zoom.find('li').toArray(),{
        finish:function(){
          
          // assign the variables that would be supplied by zynga
          var zoom = this.scale;
          var zoomed = zoom - currentScale;
          currentScale = zoom;
          
          var min = Math.round(9 / zoom);
          var filter = zoomed > 0 ? ".truncated" : function() { return parseInt($(this).css("font-size"), 10) < min; };
          content.filter(filter).fitText('circular', {font: {min: min, max: 25}});
        }
    });
  });